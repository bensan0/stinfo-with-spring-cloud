<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.personal.project.stockservice.mapper.DailyStockInfoMapper">

    <resultMap id="BaseResultMap" type="com.personal.project.stockservice.model.entity.DailyStockInfoDO">
        <id property="id" column="id" jdbcType="BIGINT"/>
        <result property="stockId" column="stock_id" jdbcType="VARCHAR"/>
        <result property="stockName" column="stock_name" jdbcType="VARCHAR"/>
        <result property="market" column="market" jdbcType="VARCHAR"/>
        <result property="date" column="date" jdbcType="BIGINT"/>
        <result property="todayClosingPrice" column="today_closing_price" jdbcType="DECIMAL"/>
        <result property="yesterdayClosingPrice" column="yesterday_closing_price" jdbcType="DECIMAL"/>
        <result property="priceGap" column="price_gap" jdbcType="DECIMAL"/>
        <result property="priceGapPercent" column="price_gap_percent" jdbcType="DECIMAL"/>
        <result property="openingPrice" column="opening_price" jdbcType="DECIMAL"/>
        <result property="highestPrice" column="highest_price" jdbcType="DECIMAL"/>
        <result property="lowestPrice" column="lowest_price" jdbcType="DECIMAL"/>
        <result property="todayTradingVolumePiece" column="today_trading_volume_piece" jdbcType="BIGINT"/>
        <result property="todayTradingVolumeMoney" column="today_trading_volume_money" jdbcType="DECIMAL"/>
        <result property="yesterdayTradingVolumePiece" column="yesterday_trading_volume_piece" jdbcType="BIGINT"/>
        <result property="yesterdayTradingVolumeMoney" column="yesterday_trading_volume_money" jdbcType="DECIMAL"/>
    </resultMap>

    <sql id="Base_Column_List">
        id,stock_id,stock_name,'date',market,today_closing_price,yesterday_closing_price,
        price_gap,price_gap_percent,opening_price,highest_price,lowest_price,
        today_trading_volume_piece,today_trading_volume_money,yesterday_trading_volume_piece,
        yesterday_trading_volume_money
    </sql>

    <select id="query4CalMetrics" parameterType="com.personal.project.stockservice.model.dto.Query4CalDTO" resultType="com.personal.project.stockservice.model.dto.DailyStockInfoDTO">
        select
            T.id as id,
            T.stock_id as stockId,
            T.stock_name as stockName,
            T.date as date,
            T.today_closing_price as todayClosingPrice,
            T.yesterday_closing_price as yesterdayClosingPrice,
            T.price_gap as priceGap,
            T.price_gap_percent as priceGapPercent,
            T.opening_price as openingPrice,
            T.highest_price as highestPrice,
            T.lowest_price as lowestPrice,
            T.today_trading_volume_piece as todayTradingVolumePiece,
            T.today_trading_volume_money as todayTradingVolumeMoney,
            T.yesterday_trading_volume_piece as yesterdayTradingVolumePiece,
            T.yesterday_trading_volume_money as yesterdayTradingVolumeMoney
        from (
            select
                tt.*,
                row_number() over (partition by stock_id order by date desc) as 'sequence'
            from (
                select *
                from daily_stock_info
                where date &lt;= #{date} and today_closing_price is not null
                 ) tt
             ) T
        where T.sequence in (1, 5, 10, 20, 60, 120, 240)
    </select>

    <select id="queryInfo4CalDetail" parameterType="com.personal.project.stockservice.model.dto.Query4CalDTO" resultType="com.personal.project.stockservice.model.dto.DailyStockInfoDTO">
        select
            t.id as id,
            t.stock_id as stockId,
            t.stock_name as stockName,
            t.date as 'date',
            t.price_gap as priceGap,
            t.price_gap_percent as priceGapPercent,
            t.today_closing_price as todayClosingPrice,
            t.yesterday_closing_price as yesterdayClosingPrice,
            t.opening_price as openingPrice,
            t.highest_price as highestPrice,
            t.lowest_price as lowestPrice,
            t.today_trading_volume_piece as todayTradingVolumePiece,
            t.yesterday_trading_volume_piece as yesterdayTradingVolumePiece,
            t.today_trading_volume_money as todayTradingVolumeMoney,
            t.yesterday_trading_volume_money as yesterdayTradingVolumeMoney
        from
            daily_stock_info t
        where
            t.date = #{date}
        union
        select
            T.id as id,
            T.stock_id as stockId,
            T.stock_name as stockName,
            T.date as 'date',
            T.price_gap_percent as priceGapPercent,
            T.today_closing_price as todayClosingPrice,
            T.today_closing_price as todayClosingPrice,
            T.yesterday_closing_price as yesterdayClosingPrice,
            T.opening_price as openingPrice,
            T.highest_price as highestPrice,
            T.lowest_price as lowestPrice,
            T.today_trading_volume_piece as todayTradingVolumePiece,
            T.yesterday_trading_volume_piece as yesterdayTradingVolumePiece,
            T.today_trading_volume_money as todayTradingVolumeMoney,
            T.yesterday_trading_volume_money as yesterdayTradingVolumeMoney
        from (
                 select
                     tt.*,
                     row_number() over (partition by stock_id order by date desc) as 'sequence'
                 from (
                          select s.*
                          from daily_stock_info s
                          where s.date &lt; #{date} and today_closing_price is not null
                      ) tt
             ) T
        where T.sequence in (1, 2, 4)
    </select>

    <select id="queryFormer" resultType="com.personal.project.stockservice.model.entity.DailyStockInfoDO">
        select
            T.id as id,
            T.stock_id as stockId,
            T.stock_name as stockName,
            T.date as 'date',
            T.today_closing_price as todayClosingPrice,
            T.yesterday_closing_price as yesterdayClosingPrice,
            T.opening_price as openingPrice,
            T.highest_price as highestPrice,
            T.lowest_price as lowestPrice,
            T.today_trading_volume_piece as todayTradingVolumePiece,
            T.yesterday_trading_volume_piece as yesterdayTradingVolumePiece,
            T.today_trading_volume_money as todayTradingVolumeMoney,
            T.yesterday_trading_volume_money as yesterdayTradingVolumeMoney
        from (
                 select
                     tt.*,
                     row_number() over (partition by stock_id order by date desc) as sequence
                 from (
                        select *
                        from daily_stock_info s
                        where s.today_closing_price is not null and s.date &lt; #{date}
                      ) tt
             ) T
        where T.sequence = 1
    </select>

    <select id="query4InitYesterdayMetrics"
            resultType="com.personal.project.stockservice.model.dto.StockInfo4InitMetricsDTO">
        select
            T.id as id,
            T.stock_id as stockId,
            T.stock_name as stockName,
            T.date as date,
            T.today_closing_price as todayClosingPrice
        from (
                select
                    tt.*,
                    row_number() over (partition by stock_id order by date desc) as 'sequence'
                from(
                        select *
                        from daily_stock_info
                        where today_closing_price is not null
                    ) tt
             ) T
        where T.sequence &lt; 242
    </select>

    <select id="queryInfo4InitYesterdayDetail" resultType="com.personal.project.stockservice.model.dto.StockInfo4InitDetailDTO">
        select
            T.id as id,
            T.stock_id   as stockId,
            T.stock_name as stockName,
            T.date as date,
            T.opening_price as openingPrice,
            T.highest_price as highestPrice,
            T.lowest_price as lowestPrice,
            T.today_closing_price as todayClosingPrice,
            T.today_trading_volume_piece as todayTradingVolumePiece,
            T.today_trading_volume_money as todayTradingVolumeMoney,
            T.sequence as sequence
        from (
                select
                    tt.*,
                    row_number() over (partition by stock_id order by date desc) as sequence
                from (
                        select *
                        from daily_stock_info
                        where today_closing_price is not null
                     ) tt
             ) T
        where T.sequence &lt; 7;
    </select>

    <select id="query4InitTodayMetrics"
            resultType="com.personal.project.stockservice.model.dto.StockInfo4InitMetricsDTO">
        select
            T.id as id,
            T.stock_id as stockId,
            T.stock_name as stockName,
            T.date as date,
            T.today_closing_price as todayClosingPrice
        from (
                select
                    tt.*,
                    row_number() over (partition by stock_id order by date desc) as 'sequence'
                from(
                        select *
                        from daily_stock_info
                        where today_closing_price is not null
                    ) tt
            ) T
        where T.sequence in (1, 5, 10, 20, 60, 120, 240);
    </select>

    <select id="query4InitTodayDetail" resultType="com.personal.project.stockservice.model.dto.DailyStockInfoDTO">
        select
            T.id as id,
            T.stock_id as stockId,
            T.stock_name as stockName,
            T.date as date,
            T.today_closing_price as todayClosingPrice,
            T.yesterday_closing_price as yesterdayClosingPrice,
            T.price_gap as priceGap,
            T.price_gap_percent as priceGapPercent,
            T.opening_price as openingPrice,
            T.highest_price as highestPrice,
            T.lowest_price as lowestPrice,
            T.today_trading_volume_piece as todayTradingVolumePiece,
            T.today_trading_volume_money as todayTradingVolumeMoney,
            T.yesterday_trading_volume_piece as yesterdayTradingVolumePiece,
            T.yesterday_trading_volume_money as yesterdayTradingVolumeMoney
        from (
                select
                    tt.*,
                    row_number() over (partition by stock_id order by date desc) as 'sequence'
                from(
                        select *
                        from daily_stock_info
                        where today_closing_price is not null
                    ) tt
                ) T
        where T.sequence in (1, 2, 3, 5);
    </select>
</mapper>